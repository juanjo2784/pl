<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner App - Flujo Dibujo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        :root { --p: #28a745; --s: #007bff; --d: #dc3545; --dark: #212529; }
        body { font-family: sans-serif; margin: 0; background: #f4f4f4; }
        .hidden { display: none !important; }
        
        /* Pantallas */
        .screen { display: flex; flex-direction: column; height: 100vh; padding: 20px; box-sizing: border-box; }
        
        /* Intro */
        .intro-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; margin: auto; width: 100%; max-width: 400px; }
        
        /* Ventana Principal */
        .header-pedido { background: var(--dark); color: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .lote-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid var(--s); position: relative; }
        
        /* Botones Flotantes Inferiores (Como en tu dibujo) */
        .nav-footer { position: fixed; bottom: 20px; left: 0; right: 0; display: flex; justify-content: space-around; padding: 0 20px; }
        .round-btn { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 24px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        /* Formulario Flujo */
        .form-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); color: white; padding: 20px; z-index: 100; }
        input, select { width: 100%; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; }
        .btn-block { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="screen-intro" class="screen">
        <div class="intro-card">
            <h2>Pedido</h2>
            <input type="text" id="input-pedido-id" placeholder="Ingrese ID Pedido">
            <button class="btn-block" style="background: var(--s); color: white;" onclick="setModo('rapido')">TRABAJO RPIDO</button>
            <button class="btn-block" style="background: var(--dark); color: white;" onclick="setModo('uno-a-uno')">UNO A UNO</button>
        </div>
    </div>

    <div id="screen-main" class="screen hidden">
        <div class="header-pedido">
            <b>Pedido:</b> <span id="display-pedido">--</span>
        </div>
        
        <div id="lista-lotes" style="flex: 1; overflow-y: auto;">
            </div>

        <div class="nav-footer">
            <button class="round-btn" style="background: var(--d);" onclick="location.reload()">X</button>
            <button class="round-btn" style="background: var(--p);" onclick="abrirScanner()">SCAN</button>
            <button class="round-btn" style="background: var(--s);" onclick="descargarCSV()"></button>
        </div>
    </div>

    <div id="overlay-flujo" class="form-overlay hidden">
        <div id="scanner-view" style="height: 200px; background: #000; margin-bottom: 15px;"></div>
        
        <h3 id="flow-title">Lote: --</h3>
        
        <div id="form-content">
            </div>
        
        <button class="btn-block" style="background: var(--d); color: white;" onclick="cerrarScanner()">CANCELAR</button>
    </div>

<script>
    let appData = { pedido: "", modo: "", lotes: [] };
    let loteActual = null;

    function setModo(m) {
        const ped = document.getElementById('input-pedido-id').value;
        if(!ped) return alert("Ingrese el pedido");
        appData.pedido = ped;
        appData.modo = m;
        document.getElementById('display-pedido').innerText = ped;
        document.getElementById('screen-intro').classList.add('hidden');
        document.getElementById('screen-main').classList.remove('hidden');
    }

    function abrirScanner() {
        document.getElementById('overlay-flujo').classList.remove('hidden');
        // Simulaci贸n de detecci贸n para este ejemplo (En producci贸n usar Quagga)
        setTimeout(() => { 
            const mockCode = "LOTE-" + Math.floor(Math.random()*1000);
            procesarDeteccion(mockCode);
        }, 1000);
    }

    function procesarDeteccion(codigo) {
        loteActual = codigo;
        document.getElementById('flow-title').innerText = "Lote: " + codigo;
        const container = document.getElementById('form-content');
        
        if(appData.modo === 'rapido') {
            container.innerHTML = `
                <label>Cant. Est谩ndar</label><input type="number" id="f-est">
                <label>Cajas Completas</label><input type="number" id="f-com">
                <label>Parcial</label><input type="number" id="f-par">
                <button class="btn-block" style="background:var(--p); color:white;" onclick="guardarLoteRapido()">GUARDAR</button>
            `;
        } else {
            // Modo Uno a Uno (Paso 2 del dibujo)
            container.innerHTML = `
                <label>Cantidad Parcial</label><input type="number" id="f-par">
                <button class="btn-block" style="background:var(--s); color:white;" onclick="registrarUno(true)">CAJA COMPLETA</button>
                <button class="btn-block" style="background:var(--p); color:white;" onclick="registrarUno(false)">GUARDAR PARCIAL</button>
            `;
        }
    }

    function guardarLoteRapido() {
        const est = document.getElementById('f-est').value;
        const com = document.getElementById('f-com').value;
        const par = document.getElementById('f-par').value;
        appData.lotes.push({ id: loteActual, est, com, par });
        actualizarLista();
        cerrarScanner();
    }

    function registrarUno(esCompleto) {
        // L贸gica para modo uno a uno
        const par = document.getElementById('f-par').value || 0;
        appData.lotes.push({ id: loteActual, est: "--", com: esCompleto ? 1 : 0, par: esCompleto ? 0 : par });
        actualizarLista();
        cerrarScanner();
    }

    function actualizarLista() {
        const lista = document.getElementById('lista-lotes');
        lista.innerHTML = appData.lotes.map((l, index) => `
            <div class="lote-item">
                <b>${l.id}</b> <br>
                <small>Cajas completas:</small> 
                <select onchange="updateLote(${index}, 'com', this.value)">
                    ${[0,1,2,3,4,5,10,20].map(v => `<option value="${v}" ${l.com == v ? 'selected' : ''}>${v}</option>`).join('')}
                </select>
                <br>
                <small>Unidades parcial:</small> <input type="number" value="${l.par}" style="width:60px; padding:5px; margin:0;" onchange="updateLote(${index}, 'par', this.value)">
            </div>
        `).join('');
    }

    function updateLote(index, campo, valor) {
        appData.lotes[index][campo] = valor;
    }

    function cerrarScanner() {
        document.getElementById('overlay-flujo').classList.add('hidden');
    }

    function descargarCSV() {
        let csv = "Pedido,Lote,Est谩ndar,Completas,Parcial\n";
        appData.lotes.forEach(l => {
            csv += `${appData.pedido},${l.id},${l.est},${l.com},${l.par}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Pedido_${appData.pedido}.csv`;
        a.click();
    }
</script>
</body>
</html>