<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner App - Entrada Manual</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --p: #28a745; --s: #007bff; --d: #dc3545; --dark: #212529; --light: #f8f9fa; }
        body { font-family: sans-serif; margin: 0; background: var(--light); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        
        /* HEADER */
        .header-pedido { background: var(--dark); color: white; padding: 15px; text-align: center; font-weight: bold; }

        /* LISTA CENTRAL */
        .list-container { flex: 1; overflow-y: auto; padding: 10px; padding-bottom: 100px; }
        .lote-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; border-left: 6px solid var(--s); box-shadow: 0 3px 6px rgba(0,0,0,0.1); position: relative; }
        
        .btn-delete { position: absolute; top: 10px; right: 10px; color: var(--d); border: none; background: none; font-size: 1.2em; cursor: pointer; }

        /* CONTROLES DE EDICIÓN */
        .controls-row { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-top: 10px; }
        .input-edit { padding: 8px; border-radius: 6px; border: 1px solid #ced4da; width: 70px; font-size: 16px; text-align: center; }

        /* RESULTADOS DE CÁLCULO */
        .calc-res { background: #f1f3f5; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.9em; border: 1px solid #dee2e6; display: flex; justify-content: space-between; }
        .calc-res b { color: var(--s); font-size: 1.1em; }

        /* FOOTER FIJO */
        .nav-footer { position: fixed; bottom: 0; left: 0; right: 0; background: var(--dark); padding: 15px; display: flex; justify-content: space-around; z-index: 100; }
        .icon-btn { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* OVERLAY ESCANER */
        #overlay-scanner { position: fixed; inset: 0; background: #000; z-index: 2000; display: flex; flex-direction: column; }
        #interactive { flex: 1; position: relative; }
        #interactive video { width: 100%; height: 100%; object-fit: cover; }
        .laser { position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: red; box-shadow: 0 0 10px red; }

        /* FORMULARIO POST-ESCANEO */
        .form-pop { background: white; padding: 20px; border-radius: 20px 20px 0 0; position: absolute; bottom: 0; width: 100%; z-index: 2100; box-sizing: border-box; }
        .btn-action { width: 100%; padding: 15px; border: none; border-radius: 8px; color: white; font-weight: bold; margin-top: 10px; }
        input[type="number"] { width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; }
    </style>
</head>
<body>

    <div id="screen-intro" style="padding: 20px; text-align: center; margin-top: 15vh;">
        <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
            <h2>Pedido</h2>
            <input type="text" id="inp-pedido" placeholder="Ingrese ID del Pedido">
            <button class="btn-action" style="background:var(--s);" onclick="iniciarApp('rapido')">TRABAJO RÁPIDO</button>
            <button class="btn-action" style="background:var(--dark);" onclick="iniciarApp('uno-a-uno')">UNO A UNO</button>
        </div>
    </div>

    <div id="screen-main" class="hidden">
        <div class="header-pedido">Pedido: <span id="txt-pedido"></span></div>
        <div class="list-container" id="container-lotes"></div>
        
        <div class="nav-footer">
            <button class="icon-btn" style="background:var(--d);" onclick="location.reload()"><i class="fas fa-undo"></i></button>
            <button class="icon-btn" style="background:var(--p);" onclick="activarEscaneo()"><i class="fas fa-barcode"></i></button>
            <button class="icon-btn" style="background:var(--s);" onclick="descargarCSV()"><i class="fas fa-file-download"></i></button>
        </div>
    </div>

    <div id="overlay-scanner" class="hidden">
        <div id="interactive"><div class="laser"></div></div>
        <div id="form-scanner" class="form-pop hidden">
            <h3 id="txt-lote-det" style="margin:0;">Lote: --</h3>
            <div id="dynamic-fields"></div>
            <button class="btn-action" style="background:var(--d);" onclick="cerrarEscaner()">CANCELAR</button>
        </div>
    </div>

<script>
    let app = { modo: "", lotes: [], memoriaEstandar: {} };

    function iniciarApp(m) {
        const p = document.getElementById('inp-pedido').value;
        if(!p) return alert("Ingrese ID de pedido");
        app.modo = m;
        document.getElementById('txt-pedido').innerText = p;
        document.getElementById('screen-intro').classList.add('hidden');
        document.getElementById('screen-main').classList.remove('hidden');
    }

    function activarEscaneo() {
        document.getElementById('overlay-scanner').classList.remove('hidden');
        document.getElementById('form-scanner').classList.add('hidden');
        Quagga.init({
            inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#interactive'), constraints: { facingMode: "environment" } },
            decoder: { readers: ["code_128_reader", "ean_reader"] }
        }, (err) => {
            if (err) return alert("Error: " + err);
            Quagga.start();
        });
    }

    Quagga.onDetected((res) => {
        Quagga.stop();
        const code = res.codeResult.code;
        if (navigator.vibrate) navigator.vibrate(100);
        mostrarFormulario(code);
    });

    function mostrarFormulario(code) {
        document.getElementById('txt-lote-det').innerText = "Lote: " + code;
        document.getElementById('form-scanner').classList.remove('hidden');
        const fields = document.getElementById('dynamic-fields');
        const est = app.memoriaEstandar[code] || "";

        if(app.modo === 'rapido') {
            fields.innerHTML = `
                <input type="number" id="f-est" placeholder="Estándar" value="${est}">
                <input type="number" id="f-com" placeholder="Cajas Completas">
                <input type="number" id="f-par" placeholder="Unidades Parciales">
                <button class="btn-action" style="background:var(--p);" onclick="validarYGuardar('${code}', 'rapido')">GUARDAR</button>
            `;
        } else {
            if(!est) {
                fields.innerHTML = `
                    <input type="number" id="f-est" placeholder="Definir Estándar">
                    <button class="btn-action" style="background:var(--s);" onclick="definirEstandar('${code}')">CONTINUAR</button>
                `;
            } else {
                fields.innerHTML = `
                    <p>Estándar: <b>${est}</b></p>
                    <input type="number" id="f-par" placeholder="Unidades Parciales">
                    <button class="btn-action" style="background:var(--s);" onclick="validarYGuardar('${code}', 'full')">CAJA COMPLETA</button>
                    <button class="btn-action" style="background:var(--p);" onclick="validarYGuardar('${code}', 'parcial')">AÑADIR PARCIAL</button>
                `;
            }
        }
    }

    function definirEstandar(code) {
        const val = parseInt(document.getElementById('f-est').value);
        if(!val || val <= 0) return alert("Estándar inválido");
        app.memoriaEstandar[code] = val;
        mostrarFormulario(code);
    }

    function validarYGuardar(code, tipo) {
        const est = app.memoriaEstandar[code] || parseInt(document.getElementById('f-est')?.value);
        if(!est) return alert("Falta estándar");
        app.memoriaEstandar[code] = est;

        let com = 0, par = 0;
        if(tipo === 'rapido') {
            com = parseInt(document.getElementById('f-com').value) || 0;
            par = parseInt(document.getElementById('f-par').value) || 0;
        } else if(tipo === 'full') {
            com = 1; par = 0;
        } else {
            com = 0; par = parseInt(document.getElementById('f-par').value) || 0;
        }

        if(par >= est) return alert(`El parcial no puede ser >= al estándar (${est})`);

        app.lotes.unshift({ id: code, est, com, par });
        actualizarLista();
        cerrarEscaner();
    }

    function actualizarLista() {
        const div = document.getElementById('container-lotes');
        div.innerHTML = app.lotes.map((l, i) => {
            const totalU = (parseInt(l.com) * parseInt(l.est)) + parseInt(l.par);
            const totalC = parseInt(l.com) + (l.par > 0 ? 1 : 0);

            return `
                <div class="lote-item">
                    <button class="btn-delete" onclick="eliminarLote(${i})"><i class="fas fa-trash-alt"></i></button>
                    <b>${l.id}</b> <small>(Est: ${l.est})</small>
                    <div class="controls-row">
                        <span>Cajas:</span>
                        <input type="number" class="input-edit" value="${l.com}" onchange="actualizarDato(${i}, 'com', this.value)">
                        <span>Parcial:</span>
                        <input type="number" class="input-edit" value="${l.par}" onchange="actualizarDato(${i}, 'par', this.value)">
                    </div>
                    <div class="calc-res">
                        <span>Tot. Cajas: <b>${totalC}</b></span>
                        <span>Tot. Unid: <b>${totalU}</b></span>
                    </div>
                </div>
            `;
        }).join('');
    }

    function actualizarDato(idx, campo, val) {
        const v = parseInt(val) || 0;
        if(campo === 'par' && v >= app.lotes[idx].est) {
            alert("Excede el estándar");
            actualizarLista();
            return;
        }
        app.lotes[idx][campo] = v;
        actualizarLista();
    }

    function eliminarLote(idx) {
        if(confirm("¿Eliminar este lote?")) {
            app.lotes.splice(idx, 1);
            actualizarLista();
        }
    }

    function descargarCSV() {
        if(app.lotes.length === 0) return alert("No hay datos");
        let csv = "\uFEFFPedido,Lote,Estándar,Cajas,Parcial,Total Unidades\n";
        app.lotes.forEach(l => {
            const tot = (l.com * l.est) + parseInt(l.par);
            csv += `${app.pedido},${l.id},${l.est},${l.com},${l.par},${tot}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Pedido_${app.pedido}.csv`;
        a.click();
    }

    function cerrarEscaner() { Quagga.stop(); document.getElementById('overlay-scanner').classList.add('hidden'); }
</script>
</body>
</html>