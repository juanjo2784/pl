<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>Scanner PL</title>
    <script src="html5-qrcode.min.js"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --dark: #2c3e50; }
        body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; background: #f4f7f6; }
        #reader { width: 100% !important; height: 35vh !important; background: #000; border-bottom: 3px solid var(--primary); }
        .controls { padding: 15px; text-align: center; background: white; }
        .btn-scan { width: 70px; height: 70px; border-radius: 50%; border: none; background: var(--success); color: white; font-size: 1.5rem; }
        .list-container { flex: 1; overflow-y: auto; padding: 10px; }
        .card { background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .qty { background: var(--primary); color: white; padding: 4px 10px; border-radius: 15px; font-weight: bold; }
        /* Paneles de entrada */
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.3); z-index: 100; display: none; text-align: center; }
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:none; z-index:90; }
        input { width: 90%; padding: 10px; margin: 10px 0; font-size: 1.1rem; border: 1px solid #ccc; border-radius: 5px; }
        .btn-action { width: 100%; padding: 12px; margin-top: 8px; border: none; border-radius: 5px; color: white; font-weight: bold; }
    </style>
</head>
<body>
    <div id="reader"></div>
    <div class="controls">
        <button class="btn-scan" id="scan-btn">üì∏</button>
        <p id="status">Presiona para escanear</p>
    </div>
    <div class="list-container" id="history"></div>

    <div class="overlay" id="overlay"></div>
    <div class="modal" id="modal-type">
        <h3 id="lote-title"></h3>
        <button class="btn-action" style="background:var(--primary)" onclick="setStandard()">üì¶ CAJA EST√ÅNDAR</button>
        <button class="btn-action" style="background:var(--dark)" onclick="setPartial()">üì• CAJA PARCIAL</button>
        <button onclick="closeModal()" style="background:none; border:none; color:red; margin-top:15px;">CANCELAR</button>
    </div>
    <div class="modal" id="modal-input">
        <h3 id="input-title"></h3>
        <input type="number" id="qty-input" inputmode="numeric">
        <button class="btn-action" style="background:var(--success)" onclick="saveData()">GUARDAR</button>
    </div>

    <script>
        let db = JSON.parse(localStorage.getItem('scans')) || {};
        let currentLote = "", currentMode = "", html5QrCode;

        function init() {
            html5QrCode = new Html5Qrcode("reader");
            renderList();
        }

        document.getElementById('scan-btn').onclick = () => {
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
                currentLote = text;
                html5QrCode.stop();
                showTypeModal();
            });
        };

        function showTypeModal() {
            document.getElementById('lote-title').innerText = "Lote: " + currentLote;
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('modal-type').style.display = 'block';
        }

        function setStandard() {
            if(db[currentLote]?.std) {
                db[currentLote].cajas++;
                save();
            } else {
                currentMode = "std";
                showInputModal("Definir Est√°ndar", "Unidades por caja:");
            }
        }

        function setPartial() {
            currentMode = "par";
            showInputModal("Caja Parcial", "Unidades en esta caja:");
        }

        function showInputModal(title, sub) {
            document.getElementById('modal-type').style.display = 'none';
            document.getElementById('modal-input').style.display = 'block';
            document.getElementById('input-title').innerText = title;
            document.getElementById('qty-input').value = "";
        }

        function saveData() {
            let val = parseInt(document.getElementById('qty-input').value);
            if(!db[currentLote]) db[currentLote] = { std: 0, cajas: 0, par: 0 };
            if(currentMode === "std") { db[currentLote].std = val; db[currentLote].cajas = 1; }
            else { db[currentLote].par += val; }
            save();
        }

        function save() {
            localStorage.setItem('scans', JSON.stringify(db));
            renderList();
            closeModal();
        }

        function closeModal() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('modal-type').style.display = 'none';
            document.getElementById('modal-input').style.display = 'none';
        }

        function renderList() {
            const container = document.getElementById('history');
            container.innerHTML = "";
            for(let key in db) {
                let total = (db[key].cajas * db[key].std) + db[key].par;
                container.innerHTML += `<div class="card">
                    <div><b>${key}</b><br><small>${db[key].cajas} cjs de ${db[key].std}</small></div>
                    <div class="qty">${total}</div>
                </div>`;
            }
        }
        window.onload = init;
    </script>
</body>
</html>