<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner App - Cálculos Automáticos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --p: #28a745; --s: #007bff; --d: #dc3545; --dark: #212529; --light: #f8f9fa; }
        body { font-family: sans-serif; margin: 0; background: var(--light); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }
        
        /* HEADER Y LISTA */
        .header-pedido { background: var(--dark); color: white; padding: 15px; text-align: center; font-weight: bold; }
        .list-container { flex: 1; overflow-y: auto; padding: 10px; }
        .lote-item { background: white; padding: 12px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid var(--s); box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 0.9em; }
        .calc-res { background: #e9ecef; padding: 5px; border-radius: 5px; margin-top: 5px; font-weight: bold; color: var(--dark); }

        /* ESCANER Y VIDEO */
        #overlay-scanner { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; flex-direction: column; }
        #interactive { flex: 1; position: relative; }
        #interactive video { width: 100%; height: 100%; object-fit: cover; }
        .laser { position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: red; z-index: 10; box-shadow: 0 0 10px red; }

        /* FORMULARIO POST-ESCANEO */
        .form-pop { background: white; padding: 20px; border-radius: 20px 20px 0 0; position: absolute; bottom: 0; width: 100%; z-index: 1200; box-sizing: border-box; }
        input, select { width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
        .btn-action { width: 100%; padding: 15px; border: none; border-radius: 8px; color: white; font-weight: bold; margin-top: 10px; cursor: pointer; }

        /* FOOTER */
        .nav-footer { background: var(--dark); padding: 15px; display: flex; justify-content: space-around; align-items: center; }
        .icon-btn { width: 60px; height: 60px; border-radius: 50%; border: none; color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    </style>
</head>
<body>

    <div id="screen-intro" style="padding: 20px; text-align: center; margin-top: 15vh;">
        <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
            <h2 style="margin:0 0 15px 0;">Pedido</h2>
            <input type="text" id="inp-pedido" placeholder="ID del Pedido">
            <button class="btn-action" style="background:var(--s);" onclick="iniciarApp('rapido')">TRABAJO RÁPIDO</button>
            <button class="btn-action" style="background:var(--dark);" onclick="iniciarApp('uno-a-uno')">UNO A UNO</button>
        </div>
    </div>

    <div id="screen-main" class="hidden">
        <div class="header-pedido">Pedido: <span id="txt-pedido"></span></div>
        <div class="list-container" id="container-lotes"></div>
        <div class="nav-footer">
            <button class="icon-btn" style="background:var(--d);" onclick="location.reload()"><i class="fas fa-times"></i></button>
            <button class="icon-btn" style="background:var(--p);" onclick="activarEscaneo()"><i class="fas fa-barcode"></i></button>
            <button class="icon-btn" style="background:#ffc107; color:black;" onclick="toggleFlash()"><i class="fas fa-lightbulb"></i></button>
        </div>
    </div>

    <div id="overlay-scanner" class="hidden">
        <div id="interactive"><div class="laser"></div></div>
        <div id="form-scanner" class="form-pop hidden">
            <h3 id="txt-lote-det" style="margin:0;">Lote: --</h3>
            <div id="dynamic-fields"></div>
            <button class="btn-action" style="background:var(--d);" onclick="cerrarEscaner()">CANCELAR</button>
        </div>
    </div>

<script>
    let app = { modo: "", lotes: [], flash: false, track: null, memoriaEstandar: {} };

    function iniciarApp(m) {
        const p = document.getElementById('inp-pedido').value;
        if(!p) return alert("Ingrese ID de pedido");
        app.modo = m;
        document.getElementById('txt-pedido').innerText = p;
        document.getElementById('screen-intro').classList.add('hidden');
        document.getElementById('screen-main').classList.remove('hidden');
    }

    function activarEscaneo() {
        document.getElementById('overlay-scanner').classList.remove('hidden');
        document.getElementById('form-scanner').classList.add('hidden');
        Quagga.init({
            inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#interactive'), constraints: { facingMode: "environment" } },
            decoder: { readers: ["code_128_reader", "ean_reader"] }
        }, (err) => {
            if (err) return alert("Error: " + err);
            Quagga.start();
            const video = document.querySelector('video');
            video.onloadedmetadata = () => { app.track = video.srcObject.getVideoTracks()[0]; };
        });
    }

    Quagga.onDetected((res) => {
        Quagga.stop();
        const code = res.codeResult.code;
        if (navigator.vibrate) navigator.vibrate(100);
        mostrarFormulario(code);
    });

    function mostrarFormulario(code) {
        document.getElementById('txt-lote-det').innerText = "Lote: " + code;
        document.getElementById('form-scanner').classList.remove('hidden');
        const fields = document.getElementById('dynamic-fields');
        const est = app.memoriaEstandar[code] || "";

        if(app.modo === 'rapido') {
            fields.innerHTML = `
                <input type="number" id="f-est" placeholder="Estándar" value="${est}">
                <input type="number" id="f-com" placeholder="Cajas Completas">
                <input type="number" id="f-par" placeholder="Unidades Parciales">
                <button class="btn-action" style="background:var(--p);" onclick="validarYGuardar('${code}', 'rapido')">GUARDAR</button>
            `;
        } else {
            if(!est) {
                fields.innerHTML = `
                    <input type="number" id="f-est" placeholder="Definir Estándar">
                    <button class="btn-action" style="background:var(--s);" onclick="definirEstandar('${code}')">CONTINUAR</button>
                `;
            } else {
                fields.innerHTML = `
                    <p style="margin:5px 0">Estándar: <b>${est}</b></p>
                    <input type="number" id="f-par" placeholder="Unidades Parciales">
                    <button class="btn-action" style="background:var(--s);" onclick="validarYGuardar('${code}', 'full')">CAJA COMPLETA</button>
                    <button class="btn-action" style="background:var(--p);" onclick="validarYGuardar('${code}', 'parcial')">AÑADIR PARCIAL</button>
                `;
            }
        }
    }

    function definirEstandar(code) {
        const val = parseInt(document.getElementById('f-est').value);
        if(!val || val <= 0) return alert("Estándar inválido");
        app.memoriaEstandar[code] = val;
        mostrarFormulario(code);
    }

    function validarYGuardar(code, tipo) {
        const est = app.memoriaEstandar[code] || parseInt(document.getElementById('f-est')?.value);
        if(!est) return alert("Falta estándar");
        app.memoriaEstandar[code] = est;

        let com = 0, par = 0;

        if(tipo === 'rapido') {
            com = parseInt(document.getElementById('f-com').value) || 0;
            par = parseInt(document.getElementById('f-par').value) || 0;
        } else if(tipo === 'full') {
            com = 1; par = 0;
        } else {
            com = 0; par = parseInt(document.getElementById('f-par').value) || 0;
        }

        // VALIDACIÓN: Parcial < Estándar
        if(par >= est) {
            alert(`Error: Las unidades parciales (${par}) no pueden ser iguales o mayores al estándar (${est}).`);
            return;
        }

        app.lotes.push({ id: code, est, com, par });
        actualizarLista();
        cerrarEscaner();
    }

    function actualizarLista() {
        const div = document.getElementById('container-lotes');
        div.innerHTML = app.lotes.map((l, i) => {
            // CÁLCULOS SEGÚN DIBUJO
            const totalUnidades = (parseInt(l.com) * parseInt(l.est)) + parseInt(l.par);
            const totalCajas = parseInt(l.com) + (l.par > 0 ? 1 : 0);

            return `
                <div class="lote-item">
                    <b>Lote: ${l.id}</b> (Est: ${l.est})<br>
                    <div style="display:flex; gap:10px; margin-top:5px; align-items:center;">
                        Cajas: <select onchange="actualizarDato(${i}, 'com', this.value)">
                            ${[0,1,2,3,4,5,10,20,50].map(v => `<option value="${v}" ${l.com==v?'selected':''}>${v}</option>`).join('')}
                        </select>
                        Unid. Parcial: <input type="number" value="${l.par}" style="width:50px;" onchange="actualizarDato(${i}, 'par', this.value)">
                    </div>
                    <div class="calc-res">
                        Total Cajas: ${totalCajas} | Total Unidades: ${totalUnidades}
                    </div>
                </div>
            `;
        }).join('');
    }

    function actualizarDato(index, campo, valor) {
        const l = app.lotes[index];
        const numVal = parseInt(valor) || 0;
        
        if(campo === 'par' && numVal >= l.est) {
            alert("El parcial no puede superar el estándar (" + l.est + ")");
            actualizarLista();
            return;
        }
        
        app.lotes[index][campo] = numVal;
        actualizarLista();
    }

    function toggleFlash() {
        if (!app.track) return alert("Linterna no disponible");
        app.flash = !app.flash;
        app.track.applyConstraints({ advanced: [{ torch: app.flash }] });
    }

    function cerrarEscaner() { Quagga.stop(); document.getElementById('overlay-scanner').classList.add('hidden'); }
</script>
</body>
</html>