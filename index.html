<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner App - Lotes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --p: #28a745; --s: #007bff; --d: #dc3545; --dark: #212529; }
        body { font-family: sans-serif; margin: 0; background: #f4f4f4; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .hidden { display: none !important; }

        /* HEADER Y LISTA */
        .header-pedido { background: var(--dark); color: white; padding: 15px; text-align: center; font-weight: bold; }
        .list-container { flex: 1; overflow-y: auto; padding: 15px; }
        .lote-item { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid var(--s); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* OVERLAY ESCANER (PANTALLA COMPLETA) */
        #overlay-scanner { position: fixed; inset: 0; background: #000; z-index: 1000; display: flex; flex-direction: column; }
        #interactive { flex: 1; position: relative; background: #000; }
        #interactive video, #interactive canvas { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        .laser { position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: red; z-index: 10; box-shadow: 0 0 10px red; }

        /* BOTONES INFERIORES */
        .nav-footer { background: var(--dark); padding: 20px; display: flex; justify-content: space-around; align-items: center; z-index: 1100; }
        .icon-btn { width: 65px; height: 65px; border-radius: 50%; border: none; color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* FORMULARIO QUE SUBE */
        .form-pop { background: white; padding: 20px; border-radius: 20px 20px 0 0; position: absolute; bottom: 0; width: 100%; z-index: 1200; box-sizing: border-box; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
        .btn-action { width: 100%; padding: 15px; border: none; border-radius: 8px; color: white; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="screen-intro" style="padding: 20px; text-align: center; margin-top: 20vh;">
        <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
            <h2>Pedido</h2>
            <input type="text" id="inp-pedido" placeholder="ID del Pedido">
            <button class="btn-action" style="background:var(--s);" onclick="iniciarApp('rapido')">TRABAJO RÁPIDO</button>
            <button class="btn-action" style="background:var(--dark);" onclick="iniciarApp('uno-a-uno')">UNO A UNO</button>
        </div>
    </div>

    <div id="screen-main" class="hidden">
        <div class="header-pedido">Pedido: <span id="txt-pedido"></span></div>
        <div class="list-container" id="container-lotes"></div>
        <div class="nav-footer">
            <button class="icon-btn" style="background:var(--d);" onclick="location.reload()"><i class="fas fa-times"></i></button>
            <button class="icon-btn" style="background:var(--p); transform: scale(1.2);" onclick="activarEscaneo()"><i class="fas fa-barcode"></i></button>
            <button class="icon-btn" style="background:#ffc107; color:black;" onclick="toggleFlash()"><i class="fas fa-lightbulb"></i></button>
        </div>
    </div>

    <div id="overlay-scanner" class="hidden">
        <div id="interactive">
            <div class="laser"></div>
        </div>
        <div id="form-scanner" class="form-pop hidden">
            <h3 id="txt-lote-det" style="margin:0 0 10px 0;">Lote: --</h3>
            <div id="dynamic-fields"></div>
            <button class="btn-action" style="background:var(--d);" onclick="cerrarEscaner()">CANCELAR</button>
        </div>
    </div>

<script>
    let config = { modo: "", lotes: [], flash: false, track: null };

    function iniciarApp(m) {
        const p = document.getElementById('inp-pedido').value;
        if(!p) return alert("Ingrese ID de pedido");
        config.modo = m;
        document.getElementById('txt-pedido').innerText = p;
        document.getElementById('screen-intro').classList.add('hidden');
        document.getElementById('screen-main').classList.remove('hidden');
    }

    function activarEscaneo() {
        document.getElementById('overlay-scanner').classList.remove('hidden');
        document.getElementById('form-scanner').classList.add('hidden');

        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: document.querySelector('#interactive'),
                constraints: {
                    facingMode: "environment", // Fuerza cámara trasera
                    width: { min: 640 },
                    height: { min: 480 }
                },
            },
            decoder: { readers: ["code_128_reader", "ean_reader", "code_39_reader"] }
        }, function(err) {
            if (err) {
                alert("Error de cámara: " + err.name);
                cerrarEscaner();
                return;
            }
            Quagga.start();
            // Intentar obtener el track para la linterna
            const video = document.querySelector('video');
            video.onloadedmetadata = () => {
                config.track = video.srcObject.getVideoTracks()[0];
            };
        });
    }

    Quagga.onDetected((res) => {
        Quagga.stop();
        const code = res.codeResult.code;
        // Vibrar al detectar
        if (navigator.vibrate) navigator.vibrate(100);
        mostrarFormulario(code);
    });

    function mostrarFormulario(code) {
        document.getElementById('txt-lote-det').innerText = "Lote: " + code;
        document.getElementById('form-scanner').classList.remove('hidden');
        const fields = document.getElementById('dynamic-fields');

        if(config.modo === 'rapido') {
            fields.innerHTML = `
                <input type="number" id="f-est" placeholder="Estándar">
                <input type="number" id="f-com" placeholder="Cajas Completas">
                <input type="number" id="f-par" placeholder="Unidades Parcial">
                <button class="btn-action" style="background:var(--p);" onclick="guardar('${code}')">GUARDAR</button>
            `;
        } else {
            fields.innerHTML = `
                <input type="number" id="f-par" placeholder="Unidades Parcial">
                <button class="btn-action" style="background:var(--s);" onclick="guardarUno('${code}', true)">CAJA COMPLETA</button>
                <button class="btn-action" style="background:var(--p);" onclick="guardarUno('${code}', false)">PARCIAL</button>
            `;
        }
    }

    function guardar(code) {
        const com = document.getElementById('f-com').value || 0;
        const par = document.getElementById('f-par').value || 0;
        config.lotes.push({ id: code, com, par });
        actualizarLista();
        cerrarEscaner();
    }

    function guardarUno(code, esFull) {
        const par = document.getElementById('f-par').value || 0;
        config.lotes.push({ id: code, com: esFull ? 1 : 0, par: esFull ? 0 : par });
        actualizarLista();
        cerrarEscaner();
    }

    function actualizarLista() {
        const div = document.getElementById('container-lotes');
        div.innerHTML = config.lotes.map((l, i) => `
            <div class="lote-item">
                <b>Lote: ${l.id}</b><br>
                <div style="display:flex; gap:10px; margin-top:5px; align-items:center;">
                    Cajas: <select onchange="config.lotes[${i}].com = this.value">
                        ${[0,1,2,3,4,5,10,20].map(v => `<option value="${v}" ${l.com==v?'selected':''}>${v}</option>`).join('')}
                    </select>
                    Unidades: <input type="number" value="${l.par}" style="width:60px;" onchange="config.lotes[${i}].par = this.value">
                </div>
            </div>
        `).join('');
    }

    function toggleFlash() {
        if (!config.track) return alert("Linterna no disponible");
        config.flash = !config.flash;
        config.track.applyConstraints({ advanced: [{ torch: config.flash }] });
    }

    function cerrarEscaner() {
        Quagga.stop();
        document.getElementById('overlay-scanner').classList.add('hidden');
    }
</script>
</body>
</html>